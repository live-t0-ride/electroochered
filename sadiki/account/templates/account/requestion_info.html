{% extends "account/account_base.html" %}
{% load zenforms sadiki_core_tags pytils_numeral %}

{% block content_title %}
    <h1>{% block title %}Информация о заявке {{ requestion }}{% endblock %}</h1>
{% endblock %}

{% block css %}
    {{ block.super }}
    {% include "includes/leaflet_css.html" %}
    <link rel="stylesheet" href="{{ STATIC_URL }}leaflet/plugins/draw/leaflet.draw.css" />
{% endblock %}

{% block bottomjs %}
    {{ block.super }}
    {% load_settings %}
        <script src="{{ STATIC_URL }}leaflet/leaflet.js"></script>
        <script src="{{ STATIC_URL }}leaflet/plugins/draw/leaflet.draw.js"></script>
        <script src="{{ STATIC_URL }}leaflet/plugins/markercluster/leaflet.markercluster.js"></script>
        <script src="{{ STATIC_URL }}leaflet/tile.stamen.js"></script>
        <script src="{{ STATIC_URL }}js/requestion.js"></script>

        <script>
            {% with requestion.location as point %}
            {% if point %}
                var requestion_point = [{{ point.y }}, {{ point.x }}]
                var requestion_marker = L.marker(requestion_point)
            {% else %}
                var requestion_point = null
                var requestion_marker = null
            {% endif %}
            var areas_ids = {{ areas_ids }};
            var map;
            var sadiksLayer;
            var prefSadikLayer;
            var sadik_location_data = {{ sadiks_location_data|safe }};
            var areas_all = [];
            {% for area in areas_all %}
                areas_all[{{ forloop.counter0 }}] = { id: {{ area.id }},
                                                      name: '{{ area.name }}',
                                                      sadiks: [],
                                                      center: {} };
            {% endfor %}

            for (s in sadik_location_data) {
                var sadik = sadik_location_data[s];
                areas_all.forEach(function(area) {
                    if (area.id == sadik.area_id) {
                        area.sadiks.push(sadik);
                    }
                });
            };

            var pref_sadiks_ids = {{ pref_sadiks_ids|safe }};
            var sadik_markers;

            function getAverageCoords(prev, curr, ind, arr) {
                if (arr.length == 1) {
                    return arr[0].location;
                }
                if (ind < (arr.length - 1)) {
                    return { location: [ prev.location[0] + curr.location[0],
                             prev.location[1] + curr.location[1] ] }
                }
                else {
                    return [ (prev.location[0] + curr.location[0]) / arr.length,
                             (prev.location[1] + curr.location[1]) / arr.length ]
                }
            }

            // условный центр списка садиков
            function get_center(sadik_list) {
                return sadik_list.reduce(getAverageCoords, {location: [0, 0]});
            }

            // вычисляем центр каждой ТО
            areas_all.forEach(function(area) {
                var center = get_center(area.sadiks);
                area.center = center;
            });

            function field_changed(element) {
                if (!$(element).find('label span.value-changed').length){
                    $(element).children("label").append('<span class="value-changed"> (Изменено)</span>');
                    $(element).children("label").addClass('changed');
                }
                // submit активный
                $('#requestion-form button:submit').attr('disabled', false);
                // сообщение при закрытии окна
                function confirmmsg() {
                    return "Все несохраненные изменения будут утеряны";
                }
                window.onbeforeunload = confirmmsg;
            }

            //отрисовка садиков на карте
            function renderMarkers(markers, map) {
                sadik_markers = {}
                if (sadiksLayer){
                    map.removeLayer(sadiksLayer)
                }
                if (prefSadikLayer){
                    map.removeLayer(prefSadikLayer)
                }
                sadiksLayer = new L.MarkerClusterGroup({
                    maxClusterRadius: 30
                });
                prefSadikLayer = new L.LayerGroup()
                var activeSadikIcon = L.icon({
                    iconUrl: '{{ STATIC_URL }}img/sadik-icon.png',

                    iconSize:     [22, 23], // size of the icon
                    iconAnchor:   [11, 11], // point of the icon which will correspond to marker's location
                    shadowAnchor: [4, 62]  // the same for the shadow
                });
                var areaSadikIcon = L.icon({
                    iconUrl: '{{ STATIC_URL }}img/sadik-icon-yellow.png',

                    iconSize:     [22, 23], // size of the icon
                    iconAnchor:   [11, 11], // point of the icon which will correspond to marker's location
                    shadowAnchor: [4, 62]  // the same for the shadow
                });
                var inactiveSadikIcon = L.icon({
                    iconUrl: '{{ STATIC_URL }}img/sadik-icon-gray.png',

                    iconSize:     [22, 23], // size of the icon
                    iconAnchor:   [11, 11], // point of the icon which will correspond to marker's location
                    shadowAnchor: [4, 62]  // the same for the shadow
                });
                function bind_popup(marker){
                    marker.bindPopup('<b>'+markers[key].name+'</b><div>Адрес: '+markers[key].address+'</div><div>Телефон: '+ markers[key].phone +'</div><a href="'+ markers[key].url +'">Перейти к ДОУ</a>');
                }
                for (var key in markers) {
                    if (jQuery.inArray(markers[key].id, pref_sadiks_ids) != -1){
                        var m = L.marker(markers[key].location.slice().reverse(),
                                {title: markers[key].name, icon: activeSadikIcon, zIndexOffset: 1000});
                        m.bindPopup('<b>'+markers[key].name+'</b><div>Адрес: '+markers[key].address+'</div><div>Телефон: '+ markers[key].phone +'</div><a href="'+ markers[key].url +'">Перейти к ДОУ</a>');
                        prefSadikLayer.addLayer(m)
                        sadik_markers[markers[key].id] = m;
                    } else {
                        if ((areas_ids !== null && areas_ids.length == 0) || jQuery.inArray(markers[key].area_id, areas_ids) != -1){
                            var m = L.marker(markers[key].location.slice().reverse(), {title: markers[key].name, icon: areaSadikIcon});
                        } else {
                            var m = L.marker(markers[key].location.slice().reverse(), {title: markers[key].name, icon: inactiveSadikIcon});
                        }
                    bind_popup(m)
                    sadiksLayer.addLayer(m);
                    }
                    sadik_markers[markers[key].id] = m;
                }
                map.addLayer(sadiksLayer, true);
                map.addLayer(prefSadikLayer)
            }
            $(document).ready(function(){
                if (requestion_marker) {
                    var map_center = requestion_point
                } else {
                    var map_center = [{{ settings.MAP_CENTER }}].reverse();
                }
                map = new L.Map("account-requestion-map", {
                    center: map_center,
                    zoom: 12
                });
                var osmLayer = new L.TileLayer("{{ settings.LEAFLET_TILES_URL }}", {
                    subdomains: {{ settings.LEAFLET_TILES_SUBDOMAINS|safe }},
                });
                osmLayer.addTo(map);

                var points = L.layerGroup([]);

                var drawnItems = new L.FeatureGroup();
                map.addLayer(drawnItems);
                if (requestion_marker) {
                    drawnItems.addLayer(requestion_marker);
                }

                {% if can_change_requestion %}
                    // Initialize the draw control and pass it the FeatureGroup of editable layers
                    var drawControlOptions = {
                        edit: {
                            featureGroup: drawnItems,
                            remove: false,
                            edit: {title: 'Изменить местоположение'}
                        },
                        draw: {
                            polyline: false,
                            polygon: false,
                            circle: false, // Turns off this drawing tool
                            rectangle: false,
                            marker: true
                        }
                    };
                    if (requestion_marker) {
                        drawControlOptions['draw']['marker'] = false;
                    }
                    var drawControl = new L.Control.Draw(drawControlOptions);
                    map.addControl(drawControl);
                {% endif %}

                function addDrawControl(map, control){
                    map.addControl(control);
                    $('.leaflet-draw-edit-edit, .leaflet-draw-draw-marker').click(function(){
                        if (requestion_point) {
                                map.panTo(requestion_point);
                        } else {
                            map.panTo(map_center);
                        }
                    })
                }

                map.on('draw:edited', function (e) {
                    e.layers.eachLayer(function (layer) {
                        lat_lng = layer.getLatLng()
                        requestion_point = [lat_lng.lat, lat_lng.lng]
                        requestion_marker = L.marker(requestion_point)
                        $('.requestion-form #id_location').val("POINT ("+ lat_lng.lng + " " + lat_lng.lat + ")")
                        field_changed($("#location-header"));
                    });
                });

                map.on('draw:created', function (e) {
                    var type = e.layerType,
                        layer = e.layer;
                    //убрать элемент добавления маркераs
                    map.removeControl(drawControl);
                    drawControlOptions['draw']['marker'] = false;
                    drawControl = new L.Control.Draw(drawControlOptions);
                    addDrawControl(map, drawControl);

                    drawnItems.clearLayers();
                    drawnItems.addLayer(layer);
                    lat_lng = layer.getLatLng()
                    requestion_point = [lat_lng.lat, lat_lng.lng]
                    requestion_marker = L.marker(requestion_point)
                    $('.requestion-form #id_location').val("POINT ("+ lat_lng.lng + " " + lat_lng.lat + ")")
                    field_changed($("#location-header"));
                });

                renderMarkers(sadik_location_data, map)
            // изменение приоритетных ДОУ
            $("#id_pref_sadiks").change(function(e, data) {
                var value = parseInt(data.value);
                if (data.type == 'add'){
                    pref_sadiks_ids.push(value);
                    renderMarkers(sadik_location_data, map)
                    map.panTo(sadik_location_data[value].location.slice().reverse())
                    sadik_markers[value].openPopup()
                } else {
                    var index = pref_sadiks_ids.indexOf(value);
                    pref_sadiks_ids.splice(index, 1);
                    renderMarkers(sadik_location_data, map)
                }

              });
            });
            $('#id_areas, #id_distribute_in_any_sadik').change(function(){
                if ($("#id_distribute_in_any_sadik").is(':checked')){
                    if ($("#id_areas").val()){
                        areas_ids = $("#id_areas").val().map(function(i) {return +i;});
                    } else {
                        areas_ids = []
                    }

                } else {
                    areas_ids = null;
                }
                renderMarkers(sadik_location_data, map)
            })
        {% endwith %}

        //при отправке формы нужно убрать запрос на обновление страницы
        function form_submit(f){
            window.onbeforeunload = null;
            $('#requestion-form button:submit').attr('disabled', true);
            f.submit();
        }

        // удаление ТО пользователем по нажатию на кнопку 'X'
        function del_field(element) {
            var parent = $(element.parentElement);
            var id = parent.children('a').next().attr('id');
            $('#id_areas option').each(function() {
                if (this.value==id) {
                    this.selected = false;
                    var index = areas_ids.indexOf(parseInt(id));
                    console.log(areas_ids, id);
                    areas_ids.splice(index, 1);
                    renderMarkers(sadik_location_data, map)
                };
            });
            $(parent).remove();
        }

        // По клику на ссылку выводим еще один select с ТО
        function add_area(element) {
            $(element).before(' \
            <select class="areas_all"> \
                <option value selected="selected">----------</option> \
                {% for area in areas_all %} \
                    <option value="{{ area.id }}">{{ area }}</option> \
                {% endfor %} \
            </select>');
        }

        //обработка нажатия на кнопку редактирвания поля
        function change_field(element){
            var parent = $(element.parentElement);
            parent.children('a').hide();
            parent.children('label').hide();
            parent.children('input, select').show();
            parent.children('input, select').focus();
            parent.children('input').blur(function() {
                parent.children('label').html(parent.children('input').val())
                parent.children('a').show();
                parent.children('label').show();
                parent.children('input').hide();
            })
            parent.children('select').blur(function() {
                parent.children('label').html(parent.find("select option:selected").text())
                parent.children('a').show();
                parent.children('label').show();
                parent.children('select').hide();
            });
        }

        // центрируем карту по ТО
        function center_area(id) {
            areas_all.forEach(function(area) {
                if (area.id == id) {
                    try {
                        map.setView([area.center[1], area.center[0]], 13);
                    } catch(err) {
                        console.log(err);
                    }
                    }
            });
        }

        // центрируем карту по садику
        function center_to_kidgdn(elem) {
            for (sadik in sadik_location_data) {
                var s = sadik_location_data[sadik];
                if (s.id == elem.id) {
                    try {
                        map.setView([s.location[1], s.location[0]], 15);
                        // после центрирования, показываем popup
                        for (key in sadik_markers) {
                            if (key == s.id) {
                                sadik_markers[key].openPopup();
                            }
                        }
                    } catch(err) {
                        console.log(err);
                    }
                }
            }
        }

        // анимация сворачивания-разворачивания детских садов
        jQuery.fn.toggleText = function(v1, v2) {
            return this.each(function() {
                var element = $(this),
                     text = element.text();

                if(text.indexOf(v1) > -1) {
                    element.text(text.replace(v1, v2));
                    element.prev().addClass("caret-right");
                    element.next().hide();
                } else {
                    element.text(text.replace(v2, v1));
                    element.prev().removeClass("caret-right");
                    element.next().show();
                }
            });
        }

        // показываем детские сады под ТО
        function show_kidgardens(elem) {
            var ul = $(elem).parent().next();
            var items = $(elem).parent().next().children()
            if (items.length <=0) {
                $(elem).next().removeClass("caret-right");
                for (s in sadik_location_data) {
                    var sadik = sadik_location_data[s];
                    if (elem.id == sadik.area_id) {
                        var li = $('<li/>')
                            .text(sadik.name)
                            .appendTo(ul);
                        var a = $('<a/>')
                            .attr('onclick', 'center_to_kidgdn(this); return false')
                            .attr('id', sadik.id)
                            .attr('href', '#')
                            .prependTo(li);
                        var img = $('<img/>')
                            .attr('src', '{{ STATIC_URL }}img/sadik-icon-gray.png')
                            .attr('height', '11')
                            .attr('width', '11')
                            .prependTo(a);
                        if (areas_ids) {
                            img.attr('src', '{{ STATIC_URL }}img/sadik-icon-yellow.png')
                        }
                        if (pref_sadiks_ids.indexOf(sadik.id) >= 0){
                            img.attr('src', '{{ STATIC_URL }}img/sadik-icon.png')
                        }
                    }
                };
            }
            else {
                items.remove();
                $(elem).next().addClass("caret-right");
            }
        }

        // добавляем выбранную ТО к areas
        $(document).on("change", ".areas_all", function() {
            var id = $(this).val();
            // собственно само добавление
            $('#id_areas option').each(function() {
                if (this.value==id) {
                    this.selected = true;
                    areas_ids.push(parseInt(id));
                    console.log(areas_ids, id);
                    renderMarkers(sadik_location_data, map)
                };
            });
            // центрируем карту по ТО
            try {
                center_area(id);
            } catch(err) {
                console.log(err);
            }

            // создаем и отображаем новое поле с выбранной ТО
            $(this).prev().prev().before(' \
            <p class="field-value hidden-input"> \
                <a id="area_map_anchor" class="icon-map-marker" href="#" onclick="center_area(' + id + '); return false"></a> \
                <a id="' + id + '" class="value value-anchor" href="#" onclick="show_kidgardens(this); return false">' + $(this).children(":selected").text() + '</a> \
                <span class="caret caret-right caret-margins"></span> \
                <a href="#" onclick="del_field(this); return false"> \
                <img id="area-close" src="/static/img/remove.png"></a> \
            </p> \
            <ul class="kidgs_list unstyled"></ul>');

            // помечаем блок измененным
            var container_el = $(this).parents('.field');
            field_changed(container_el);
            // удаляем поле select
            $(this).remove();
         });

        $(document).ready(function(){
            // прячем родной m2m django виджет
            $('#id_areas').hide();
            // сообщение о том, что поле было изменено + запрос при закрытии окна
            $('input, select').bind('change', function(){
                var container_el = $(this).parents('.field');
                field_changed(container_el);
            })
            $('p').bind('remove', function(){
                var container_el = $(this).parents('.field');
                field_changed(container_el);
            })
        });
        </script>
{% endblock %}

{% block content %}
    {% block top_block %}
        <div class='notification-area'>
        {% if not can_change_requestion %}
            <div class="alert alert-error">Статус заявки: {{ requestion.get_status_display }}. Редактирование невозможно.</div>
        {% else %}
            {% if not requestion.document_confirmed %}
                <div class="alert alert-error">Вам необходимо в ближайшее время подтвердить заявку, обратившись в управление образования.</div>
            {% else %}
                <div class="alert alert-error">После документального подтверждения, изменение льгот и документов возможно только через оператора.</div>
            {% endif %}
        {% endif %}
        </div>
    {% endblock top_block %}
<form id="requestion-form" action='.' method="post" class="requestion-form {% if not can_change_requestion %}form-disabled{% endif %}" onsubmit="form_submit(this); return false">
<div class="row">
    {% csrf_token %}
    {{ pref_sadiks_form.media }}
    {{ change_requestion_form.media }}
    {{ change_benefits_form.media }}
    {{ pref_sadiks_form.non_field_errors }}
    {{ change_requestion_form.non_field_errors }}
    {{ change_benefits_form.non_field_errors }}
    <div class="span6">
    <div class="requestion-info">
        <div class="block-head">Информация о заявке:</div>
        <div class="{% if change_requestion_form.name.errors %}error {% endif %}field">
            <label class="field-label">{{ change_requestion_form.name.label }}{% if change_requestion_form.name.errors %}<span class="value-changed"> ({{ change_requestion_form.name.errors|striptags }})</span>{% endif %}</label>
            <p class="field-value hidden-input">
                <label class="value">{{ change_requestion_form.name.value }}</label>
                {{ change_requestion_form.name }}
                <a href="#" onclick="change_field(this); return false"><img src="{{ STATIC_URL }}img/icon_edit.fw.png"/></a>
            </p>
        </div>
        <div class="{% if change_requestion_form.sex.errors %}error {% endif %}field">
            <label class="field-label">{{ change_requestion_form.sex.label }}{% if change_requestion_form.sex.errors %}<span class="value-changed"> ({{ change_requestion_form.sex.errors|striptags }})</span>{% endif %}</label>
            <p class="field-value hidden-input">
                <label class="value">{{ change_requestion_form.sex|form_field_verbose }}</label>
                {{ change_requestion_form.sex }}
                <a href="#" onclick="change_field(this); return false"><img src="{{ STATIC_URL }}img/icon_edit.fw.png"/></a>
            </p>
        </div>
        <div class="field">
            <label class="field-label">Дата регистрации</label>
            <p class="field-value">
                <span class="value">{{ requestion.registration_datetime }}</span>
            </p>
        </div>
        <div class="field">
            <label class="field-label">Дата рождения</label>
            <p class="field-value">
                <span class="value">{{ requestion.birth_date }}</span>
            </p>
        </div>
        <div class="field">
            <label class="field-label">Возрастная группа</label>
            <p class="field-value">
                <span class="value">{{ requestion.age_groups.0|default:"Ребёнок не попадает ни в одну возрастную категорию." }}</span>
            </p>
        </div>
        <div class="field">
            <label class="field-label">Желаемый год поступления</label>
            <p class="field-value hidden-input">
                <label class="value">{{ requestion.admission_date.year }}</label>
                {{ change_requestion_form.admission_date }}
                 <a href="#" onclick="change_field(this); return false"><img src="{{ STATIC_URL }}img/icon_edit.fw.png"/></a>

            </p>
        </div>

        <div class="hidden">
            {{ change_requestion_form.location }}
        </div>
    </div>
    </div>
    <div class="span5">
        {% block top_right %}
        <div class="requestion-info">
        <div class="field">
            <label class="field-label">Статус</label>
            {% if requestion.document_confirmed %}
                <p class="field-value">{{ requestion.get_status_display }}</p>
            {% else %}
                <div class="document-info">
                <img src="{{ STATIC_URL }}img/icon_not_approved.fw.png"/>
                <p class="field-value">
                    {{ requestion.get_status_display }}
                    {% if requestion.status == STATUS_REQUESTER_NOT_CONFIRMED %}
                    <span class="status-not-approved">Статус не подтвержден оператором</span>
                    {% endif %}
                </p>
                </div>
            {% endif %}
        </div>
        <div class="block-head top-indent">Документы:</div>
        <div class="field">
            {% for document in requestion.evidience_documents %}
            <label class="field-label">{{ document.template }}</label>
            <div>
                <span class="document-info">
                {% if not document.confirmed %}
                    <img src="{{ STATIC_URL }}img/icon_not_approved.fw.png"/>
                    <div class="field-value">
                        {{ document.document_number }}
                        <span class="status-not-approved">Документ не подтвержден оператором</span>
                    </div>
                {% else %}
                    <img src="{{ STATIC_URL }}img/icon_approved.fw.png"/>
                    <div class="field-value">
                        {{ document.document_number }}
                        <span class="status-approved">Документ подтвержден</span>
                    </div>
                {% endif %}
                </span>
            </div>
            {% endfor %}
        </div>
        <div class="field">
            <label class="field-label">Льготы</label>
            {% if can_change_benefits %}
                {{ change_benefits_form.benefits }}
            {% else %}
                {% with requestion.benefits.all as requestion_benefits %}
                    {% if requestion_benefits %}
                    <ul class="benefits-list">
                        {% for benefit in requestion_benefits%}
                            <li class="bsmListItem"><span class="bsmListItemLabel">{{ benefit }}</span></li>
                        {% endfor %}
                    </ul>
                    {% else %}
                        <p class="field-value">Не заданы</p>
                    {% endif %}
                {% endwith %}
                {% if can_change_requestion %}
                    <span class="status-not-approved">Для изменения льгот обратитесь к оператору</span>
                {% endif %}
            {% endif %}
        </div>
        </div>
        {% endblock top_right %}
    </div>
</div>

<div class="row">
    <div class="requestion-info span11">
        <div class="split-line"></div>
        <div class="block-head">Выбор ДОУ</div>
    </div>
</div>
<div class="row sadiks-block">
    <div class="span6">
        <div class="requestion-info">

        <div class="{% if pref_sadiks_form.areas.errors %}error {% endif %}field">
            <label class="field-label">{{ pref_sadiks_form.areas.label }}{% if pref_sadiks_form.areas.errors %}<span class="value-changed"> ({{ pref_sadiks_form.areas.errors|striptags }})</span>{% endif %}</label>
            {% for area in requestion.areas.all %}
                <p class="field-value hidden-input">
                    <a id="area_map_anchor" class="icon-map-marker" href="#" onclick="center_area({{ area.id }}); return false"></a>
                    <a id="{{ area.id }}" class="value value-anchor" href="#" onclick="show_kidgardens(this); return false">
                        {% if pref_sadiks_form.areas.value %}
                            {{ area|default:"Весь муниципалитет" }}
                        {% else %}
                            Весь муниципалитет
                        {% endif %}
                    </a> <span class="caret caret-right caret-margins"></span>
                    <a href="#" onclick="del_field(this); return false"><img id="area-close" src="{{ STATIC_URL }}img/remove.png"/></a>
                </p>
                <ul class="kidgs_list unstyled">
                </ul>
            {% endfor %}
            {{ pref_sadiks_form.areas }}
            <p></p><a href="#" onclick="add_area(this); return false"><i class="icon-plus"></i>Добавить территориальную область</a></p>
        </div>
        <div class="field">
            <label class="field-label">Приоритетные ДОУ</label>
            {% if can_change_requestion %}
                {{ pref_sadiks_form.pref_sadiks }}
            {% else %}
                {% with requestion.pref_sadiks.all as requestion_sadiks %}
                    {% if requestion_sadiks %}
                    <ul class="benefits-list">
                        {% for sadik in requestion_sadiks %}
                            <li class="bsmListItem"><span class="bsmListItemLabel">{{ sadik }}</span></li>
                        {% endfor %}
                    </ul>
                    {% else %}
                        <p class="field-value">Не заданы</p>
                    {% endif %}
                {% endwith %}
            {% endif %}
        </div>
        </div>
    </div>
    <div class="span5">
        <div class="requestion-info">
        <div id="location-header" class="{% if change_requestion_form.location.errors %}error {% endif %}field">
            <label class="field-label">{{ change_requestion_form.location.label }} {% if change_requestion_form.location.errors %} <span class="errors">({% for error in change_requestion_form.location.errors %}{{ error }}{% endfor %})</span>{% endif %}</label>
            <div id="account-requestion-map"></div>
            <p class="hint">Относительно этого местоположения оператор будет подбирать ближайшие ДОУ, если на момент распределения заявки в приоритетных садах не будет свободных мест.</p>
        </div>
        </div>
        <ul class='map-legend'>
            <li><img src="{{ STATIC_URL }}img/sadik-icon.png"/> - выбранные приоритетные ДОУ</li>
            <li><img src="{{ STATIC_URL }}img/sadik-icon-yellow.png"/> - в один из этих ДОУ заявка будет зачислена, если в приоритетных не останется места</li>
            <li><img src="{{ STATIC_URL }}img/sadik-icon-gray.png"/> - остальные ДОУ муниципалитета</li>
        </ul>
    </div>
</div>
{% if can_change_requestion %}
<div class="row">
    <div class="span11">
        <button class="btn btn-primary btn-large" type="submit" disabled="disabled">Сохранить</button>
    </div>
</div>
{% endif %}
</form>
{% block bottom %}
    <div class="requestion-queue">
        <div class="split-line"></div>
        <div class="block-head">Очередь заявок</div>
        <div class="queue-info">
            <p>Заявок перед Вами: <span class="number">{{ requestions_before }}</span>
                (Из них льготников: <span class="number">{{ benefits_before }}.</span>
                Документально подтвержденных: <span class="number">{{ confirmed_before }}</span>)</p>
            <p>Заявок после Вас: <span class="number">{{ requestions_after }}</span> (
                Из них льготников: <span class="number">{{ benefits_after }}.</span>
                Документально подтвержденных: <span class="number">{{ confirmed_after }}</span>)</p>
        </div>
        {% with queue as object_list %}
        {% with requestion as target_requestion %}
            {% include "anonym/includes/queue_include.html" %}
        {% endwith %}
        {% endwith %}

        <div class="block-head"><a href="{% url anonym_queue  %}?requestion_number={{ requestion.requestion_number }}">Смотреть всю очередь</a></div>
    </div>
{% endblock bottom %}
{% endblock %}
