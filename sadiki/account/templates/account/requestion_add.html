{% extends "account/account_base.html" %}
{% load zenforms sadiki_core_tags %}

{% block js %}
    {{ block.super }}
    {{ openlayers_js }}
{% endblock %}

{% block css %}
    {{ block.super }}
    {% include "includes/leaflet_css.html" %}
    <link rel="stylesheet" href="{{ STATIC_URL }}leaflet/plugins/draw/leaflet.draw.css" />
{% endblock %}

{% block bottomjs %}
    {{ block.super }}
    <script src="{{ STATIC_URL }}leaflet/leaflet.js"></script>
    <script src="{{ STATIC_URL }}leaflet/plugins/draw/leaflet.draw.js"></script>
    <script src="{{ STATIC_URL }}leaflet/plugins/markercluster/leaflet.markercluster.js"></script>
    <script src="{{ STATIC_URL }}leaflet/tile.stamen.js"></script>
    <script type="text/javascript">
        {% load_settings %}
        var areas_ids = [];
        var requestion_point = null;
        var requestion_marker = null;
        var map;
        var sadiksLayer;
        var areaSadiksLayer;
        var prefSadikLayer;
        var sadik_location_data = {{ sadiks_location_data|safe }};
        var pref_sadiks_ids = [];
        var sadik_markers;

        //отрисовка садиков на карте
        function renderMarkers(markers, map) {
            sadik_markers = {}
            if (sadiksLayer){
                map.removeLayer(sadiksLayer)
            }
            if (prefSadikLayer){
                map.removeLayer(prefSadikLayer)
            }
            sadiksLayer = new L.MarkerClusterGroup({
                maxClusterRadius: 30,
            });
            prefSadikLayer = new L.LayerGroup()
            var activeSadikIcon = L.icon({
                iconUrl: '{{ STATIC_URL }}img/sadik-icon.png',

                iconSize:     [22, 23], // size of the icon
                iconAnchor:   [11, 11], // point of the icon which will correspond to marker's location
                shadowAnchor: [4, 62]  // the same for the shadow
            });
            var areaSadikIcon = L.icon({
                iconUrl: '{{ STATIC_URL }}img/sadik-icon-yellow.png',

                iconSize:     [22, 23], // size of the icon
                iconAnchor:   [11, 11], // point of the icon which will correspond to marker's location
                shadowAnchor: [4, 62]  // the same for the shadow
            });
            var inactiveSadikIcon = L.icon({
                iconUrl: '{{ STATIC_URL }}img/sadik-icon-gray.png',

                iconSize:     [22, 23], // size of the icon
                iconAnchor:   [11, 11], // point of the icon which will correspond to marker's location
                shadowAnchor: [4, 62]  // the same for the shadow
            });
            function bind_popup(marker){
                marker.bindPopup('<b>'+markers[key].name+'</b><div>Адрес: '+markers[key].address+'</div><div>Телефон: '+ markers[key].phone +'</div><a href="'+ markers[key].url +'">Перейти к ДОУ</a>');
            }
            for (var key in markers) {
                if (jQuery.inArray(markers[key].id, pref_sadiks_ids) != -1){
                    var m = L.marker(markers[key].location.slice().reverse(),
                            {title: markers[key].name, icon: activeSadikIcon, zIndexOffset: 1000});
                    bind_popup(m)
                    prefSadikLayer.addLayer(m)
                } else {
                    if (jQuery.inArray(markers[key].area_id, areas_ids) != -1){
                        var m = L.marker(markers[key].location.slice().reverse(), {title: markers[key].name, icon: areaSadikIcon});
                    } else {
                        var m = L.marker(markers[key].location.slice().reverse(), {title: markers[key].name, icon: inactiveSadikIcon});
                    }
                bind_popup(m)
                sadiksLayer.addLayer(m);
                }
                sadik_markers[markers[key].id] = m;
            }
            map.addLayer(sadiksLayer, true);
            map.addLayer(prefSadikLayer)
        }
        var drawnItems = new L.FeatureGroup();
        // Initialize the draw control and pass it the FeatureGroup of editable layers
        var draw_control_options = {
            edit: {
                featureGroup: drawnItems,
                remove: false,
                edit: {title: 'Изменить местоположение'}
            },
            draw: {
                polyline: false,
                polygon: false,
                circle: false, // Turns off this drawing tool
                rectangle: false,
                marker: true
            }
        }
        var drawControl = new L.Control.Draw(draw_control_options);

        $(document).ready(function(){
            if (requestion_marker) {
                var map_center = requestion_point
            } else {
                var map_center = [{{ settings.MAP_CENTER }}].reverse();
            }
            map = new L.Map("account-requestion-map", {
                center: map_center,
                zoom: 12
            });

            var osmLayer = new L.TileLayer("{{ settings.LEAFLET_TILES_URL }}", {
                subdomains: {{ settings.LEAFLET_TILES_SUBDOMAINS|safe }}
            });
            osmLayer.addTo(map);

            var points = L.layerGroup([]);

            map.addLayer(drawnItems);
            if (requestion_marker){
                drawnItems.addLayer(requestion_marker);
            }


            map.addControl(drawControl);

            map.on('draw:edited', function (e) {
                e.layers.eachLayer(function (layer) {
                    lat_lng = layer.getLatLng()
                    requestion_point = [lat_lng.lat, lat_lng.lng]
                    requestion_marker = L.marker(requestion_point)
                    $('.requestion-form #id_location').val("POINT ("+ lat_lng.lng + " " + lat_lng.lat + ")")
                });
            });

            map.on('draw:created', function (e) {
                var type = e.layerType,
                    layer = e.layer;
                //убрать элемент добавления маркераs
                map.removeControl(drawControl);
                draw_control_options['draw']['marker'] = false;
                drawControl = new L.Control.Draw(draw_control_options);
                map.addControl(drawControl);

                drawnItems.clearLayers();
                drawnItems.addLayer(layer);
                lat_lng = layer.getLatLng()
                requestion_point = [lat_lng.lat, lat_lng.lng]
                requestion_marker = L.marker(requestion_point)
                $('.requestion-form #id_location').val("POINT ("+ lat_lng.lng + " " + lat_lng.lat + ")")
            });

            $('.leaflet-draw-edit-edit, .leaflet-draw-draw-marker').click(function(){
                if (requestion_point) {
                        map.panTo(requestion_point);
                } else {
                    map.panTo(map_center);
                }
            })
            renderMarkers(sadik_location_data, map)
        // изменение приоритетных ДОУ
        $("#id_pref_sadiks").change(function(e, data) {
            var value = parseInt(data.value);
            if (data.type == 'add'){
                pref_sadiks_ids.push(value);
                renderMarkers(sadik_location_data, map)
                map.panTo(sadik_location_data[value].location.slice().reverse())
                sadik_markers[value].openPopup()
            } else {
                var index = pref_sadiks_ids.indexOf(value);
                pref_sadiks_ids.splice(index, 1);
                renderMarkers(sadik_location_data, map)
            }

          });
        })

        $('#id_areas').change(function(){
            if ($(this).val()){
                areas_ids = [parseInt($(this).val())]
            } else {
                areas_ids = []
            }
            renderMarkers(sadik_location_data, map)
        })
    </script>

    <script type="text/javascript">
        $(document).ready(function(){
            $('#id_template').regexpValidate('#id_document_number');
        });
    </script>
{% endblock %}

{% block content_title %}
    <h1>{% block title %}Добавить заявку{% endblock %}</h1>
{% endblock %}

{% block content %}
    <form action="." class="requestion-form requestion-add-form" method="POST">
        {% csrf_token %}
        {{ form.media }}
        {{ benefits_form.media }}
        {% if form.non_field_errors or benefits_form.non_field_errors %}
            <div id="errorMsg">
                {% load i18n %}
                <h3>
                {% blocktrans count form.non_field_errors|length as counter %}Please correct the error below.{% plural %}Please correct the errors below.{% endblocktrans %}
                </h3>
                <ol>
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                    {% for error in benefits_form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ol>
            </div>
        {% endif %}
        <div class="row">
            <div class="requestion-info span11">
                <div class="block-head">Информация о заявке</div>
            </div>
        </div>
        <div class="row">
            <div class="span5">
                <div class="requestion-info">
                    {% with form.name as field %}
                        {% include "account/include/requestion-form-field.html" %}
                    {% endwith %}
                    {% with form.birth_date as field %}
                        {% include "account/include/requestion-form-field.html" %}
                    {% endwith %}
                    {% with form.sex as field %}
                        {% include "account/include/requestion-form-field.html" %}
                    {% endwith %}
                    {% with form.admission_date as field %}
                        {% include "account/include/requestion-form-field.html" %}
                    {% endwith %}
                </div>
            </div>
            <div class="span6">
                <div class="requestion-info">
                    {% with form.template as field %}
                        {% include "account/include/requestion-form-field.html" %}
                    {% endwith %}
                    {% with form.document_number as field %}
                        {% include "account/include/requestion-form-field.html" %}
                    {% endwith %}
                    <div class="small-field">
                    {% with benefits_form.benefits as field %}
                        {% include "account/include/requestion-form-field.html" %}
                    {% endwith %}
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="requestion-info span11">
                <div class="split-line"></div>
                <div class="block-head">Выбор ДОУ</div>
            </div>
        </div>
        <div class="row sadiks-block">

            <div class="span5">
                <div class="requestion-info">
                {% with form.areas as field %}
                    {% include "account/include/requestion-form-field.html" %}
                {% endwith %}
                {% with form.pref_sadiks as field %}
                    <div class="small-field">
                        {% include "account/include/requestion-form-field.html" %}
                    </div>
                {% endwith %}
                <div class="field">
                    {% with form.distribute_in_any_sadik as field %}
                        {{ field }}
                        <label class="field-label distribute_in_any_sadik" for="{{ field.id_for_label }}">{{ field.label }}</label>
                    {% endwith %}
                </div>
                </div>
            </div>
            <div class="span6">
                <div class="requestion-info">
                <div class="field {% if form.location.errors %}error{% endif %}">
                    <div id="location-header">
                        <label class="field-label">Ваше местоположение {% if form.location.errors %} <span class="errors">({% for error in form.location.errors %}{{ error }}{% endfor %}){% endif %}</label>
                    </div>
                    <div class="hidden">
                        {{ form.location }}
                    </div>
                    <div id="account-requestion-map"></div>
                    <p class="hint">Относительно этого местоположения оператор будет подбирать ближайшие ДОУ, если на момент распределения заявки в приоритетных садах не будет свободных мест.</p>
                </div>
                <ul class='map-legend'>
                    <li><img src="{{ STATIC_URL }}img/sadik-icon.png"/> - выбранные приоритетные ДОУ</li>
                    <li><img src="{{ STATIC_URL }}img/sadik-icon-yellow.png"/> - в один из этих ДОУ заявка будет зачислена, если в приоритетных не останется места</li>
                    <li><img src="{{ STATIC_URL }}img/sadik-icon-gray.png"/> - остальные ДОУ муниципалитета</li>
                </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="span11">
                <div class="uniForm">
                <div class="buttonHolder">
                    <button class="primaryAction" type="submit">Добавить</button>
                </div>
                </div>
            </div>
        </div>
    </form>
{% endblock %}
